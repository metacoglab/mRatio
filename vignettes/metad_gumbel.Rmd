---
title: "metad_gumbel"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{metad_gumbel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r models_dir, include = FALSE}
dir.create("models", showWarnings = FALSE)
```

```{r setup}
library(tidyverse)
library(brms)
library(tidybayes)
library(mRatio)
```


```{r gumbel_min}
gumbel_min_lccdf <- function(y, g) {
  -exp(y - g)
}
gumbel_min_lcdf <- function(y, g) {
  log1p(-exp(-exp(y - g)))
}
gumbel_min <- stanvar(
  scode = "
  real gumbel_min_lccdf(real y, real g) {
    return -exp(y - g);
  }
  real gumbel_min_lcdf(real y, real g) {
    return log1m_exp(-exp(y - g));
  }",
  block = "functions"
)
```

```{r model}
d <- sim_metad(
  N_trials = 1000000, d_prime = .75, c = -.5, log_M = -1,
  c2_0 = c(.25, .75, 1), c2_1 = c(.5, 1, 1.25)
)

g <- fit_metad(bf(N ~ 0 + Intercept),
  data = d,
  prior = prior(normal(0, 1)) +
    prior(normal(0, 1), class = dprime) +
    prior(normal(0, 1), class = c) +
    prior(lognormal(0, 1), class = metac2zero1diff) +
    prior(lognormal(0, 1), class = metac2zero2diff) +
    prior(lognormal(0, 1), class = metac2one1diff) +
    prior(lognormal(0, 1), class = metac2one2diff),
  stanvars = gumbel_min, file = "models/gumbel.rds"
)
summary(g, prior = TRUE)
```

```{r epred}
epred_draws(g, newdata = tibble(.row = 1)) |>
  group_by(.row, .category) |>
  median_qi(.epred) |>
  mutate(.true = response_probabilities(g$data$N[1, ])) |>
  separate(.category,
    into = c("var", "stimulus", "joint_response"),
    sep = "_", convert = TRUE
  ) |>
  mutate(
    response = factor(as.integer(joint_response > max(joint_response) / 2)),
    confidence = factor(ifelse(joint_response > max(joint_response) / 2,
      joint_response - max(joint_response) / 2,
      max(joint_response) / 2 - joint_response + 1
    ))
  ) |>
  ggplot(aes(x = joint_response)) +
  geom_col(aes(y = .true, fill = response, alpha = confidence), ) +
  geom_pointrange(aes(y = .epred, ymin = .lower, ymax = .upper)) +
  scale_alpha_discrete(range = c(.25, 1)) +
  facet_wrap(~stimulus, labeller = label_both) +
  theme_classic()
```

```{r mean_confidence}
## calculate mean confidence per stimulus
tibble(.row = 1) |>
  add_mean_confidence_draws(g) |>
  median_qi(.epred) |>
  left_join(d |>
    group_by(stimulus, response, confidence) |>
    summarize(theta_2 = first(theta_2)) |>
    group_by(stimulus, response) |>
    summarize(.true = sum(theta_2 * confidence)))
```

```{r roc1}
# psuedo type-1 ROC
tibble(.row = 1) |>
  add_roc1_draws(g, bounds = TRUE) |>
  median_qi(p_fa, p_hit) |>
  ggplot(aes(
    x = p_fa, xmin = p_fa.lower, xmax = p_fa.upper,
    y = p_hit, ymin = p_hit.lower, ymax = p_hit.upper
  )) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_errorbar(orientation = "y", width = .01) +
  geom_errorbar(orientation = "x", width = .01) +
  geom_line() +
  coord_fixed(xlim = 0:1, ylim = 0:1, expand = FALSE) +
  xlab("P(False Alarm)") +
  ylab("P(Hit)") +
  theme_bw()
```

```{r roc2}
# type 2 ROC
roc2_draws(g, tibble(.row = 1), bounds = TRUE) |>
  median_qi(p_hit2, p_fa2) |>
  mutate(response = factor(response)) |>
  ggplot(aes(
    x = p_fa2, xmin = p_fa2.lower, xmax = p_fa2.upper,
    y = p_hit2, ymin = p_hit2.lower, ymax = p_hit2.upper,
    color = response
  )) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_errorbar(orientation = "y", width = .01) +
  geom_errorbar(orientation = "x", width = .01) +
  geom_line() +
  coord_fixed(xlim = 0:1, ylim = 0:1, expand = FALSE) +
  xlab("P(Type 2 False Alarm)") +
  ylab("P(Type 2 Hit)") +
  theme_bw()
```
